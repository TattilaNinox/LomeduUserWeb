════════════════════════════════════════════════════════════════════════════════
LOMEDU FREEMIUM MODELL - IMPLEMENTÁCIÓS ÖSSZEFOGLALÓ
════════════════════════════════════════════════════════════════════════════════
Dátum: 2025. október 22.
Verzió: 1.0
Platform: Webalkalmazás (Flutter Web)

════════════════════════════════════════════════════════════════════════════════
I. ÁTTEKINTÉS
════════════════════════════════════════════════════════════════════════════════

A Lomedu webalkalmazás freemium (próbavásárlás alapú) üzleti modellt alkalmaz:

  ✓ Ingyenes felhasználók: Csak az isFree: true jegyzeteket nyithatják meg
  ✓ Prémium felhasználók: Minden jegyzetet elérhetnek
  ✓ Próbaidőszakos felhasználók: 5 napig prémium hozzáférés
  ✓ MINDEN felhasználó: Látja az összes jegyzet CÍMÉT (lock ikonnal jelezve)

════════════════════════════════════════════════════════════════════════════════
II. IMPLEMENTÁLT VÁLTOZTATÁSOK
════════════════════════════════════════════════════════════════════════════════

────────────────────────────────────────────────────────────────────────────────
1. FIRESTORE SECURITY RULES (firestore.rules)
────────────────────────────────────────────────────────────────────────────────

Módosított szabály a /notes/{noteId} gyűjteményre:

┌────────────────────────────────────────────────────────────────────────────┐
│  KORÁBBI (allow read - mindkét műveletre egyszerre):                       │
│    allow read: if request.auth != null &&                                  │
│                   (isAdmin() ||                                             │
│                    (resource.data.status in ['Published', 'Public'] &&     │
│                     (resource.data.isFree == true || hasPremiumAccess()))); │
│                                                                             │
│  ÚJ (list + get külön kezelve):                                            │
│    allow list: if request.auth != null &&                                  │
│                   (isAdmin() || resource.data.status in [...]);            │
│                                                                             │
│    allow get: if request.auth != null &&                                   │
│                  (isAdmin() ||                                              │
│                   (resource.data.status in ['Published', 'Public'] &&      │
│                    (resource.data.isFree == true || hasPremiumAccess()))); │
└────────────────────────────────────────────────────────────────────────────┘

MAGYARÁZAT:

  • `allow list`: Lista lekérdezések (notes.where(...).get()) - MINDEN 
    bejelentkezett felhasználó láthatja a Published/Public jegyzeteket
    
  • `allow get`: Egyedi lekérdezések (notes.doc(id).get()) - CSAK ingyenes
    jegyzetek vagy prémium hozzáféréssel rendelkező felhasználók esetén

  • hasPremiumAccess() helper függvény:
    - Ellenőrzi: isSubscriptionActive == true
    - VAGY: freeTrialEndDate > now (próbaidőszak aktív)

────────────────────────────────────────────────────────────────────────────────
2. KLIENS-OLDALI KÓD (lib/widgets/note_card_grid.dart)
────────────────────────────────────────────────────────────────────────────────

✓ NINCS szűrés isFree alapján (71. sor komment)
✓ Minden jegyzet látszik a listában
✓ hasPremiumAccess flag számítása (25-38. sor)
✓ isLocked flag átadása NoteListTile-nak (311, 327. sor)

Kód részlet:

  // FREEMIUM MODEL: Minden jegyzet látszik, de a zártak nem nyithatók meg
  // Nem szűrünk isFree alapján, hogy a prémium jegyzetek is látszódjanak
  
  final isFree = data['isFree'] as bool? ?? true;
  final isLocked = !isFree && !widget.hasPremiumAccess;

────────────────────────────────────────────────────────────────────────────────
3. UI MEGJELENÍTÉS (lib/widgets/note_list_tile.dart)
────────────────────────────────────────────────────────────────────────────────

✓ Vizuális jelzések zárt jegyzeteknél:
  - Elhalványítás: opacity: 0.6 (204. sor)
  - Lock ikon: 🔒 narancs színnel (273-280. sor)
  - Halványabb háttér és keret (196-199. sor)

✓ Funkcionális védelem:
  - Kattintás esetén hibaüzenet (55-70. sor)
  - "Előfizetés" gomb az üzenetben (61-66. sor)
  - Átirányítás /account oldalra

Kód részlet:

  if (isLocked) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: const Text(
            'Ez a tartalom csak előfizetőknek érhető el. ...'),
        action: SnackBarAction(
          label: 'Előfizetés',
          onPressed: () => context.go('/account'),
        ),
      ),
    );
    return; // Nem nyitjuk meg
  }

────────────────────────────────────────────────────────────────────────────────
4. RÉSZLETES NÉZET VÉDELEM
────────────────────────────────────────────────────────────────────────────────

A) NotePagesScreen (lib/screens/note_pages_screen.dart)

✓ Try-catch blokk a Firestore lekérdezés körül (39-60. sor)
✓ Permission denied hiba kezelése (54-59. sor)
✓ Hibaüzenet + visszairányítás (62-86. sor)

Kód részlet:

  try {
    final snapshot = await FirebaseFirestore.instance
        .collection('notes')
        .doc(widget.noteId)
        .get();
    // ...
  } catch (e) {
    // Firestore permission denied hiba
    if (mounted) {
      _showAccessDeniedAndGoBack();
    }
  }

B) InteractiveNoteViewScreen (lib/screens/interactive_note_view_screen.dart)

✓ Stream hibakezelés: onError callback (63-70. sor)
✓ _accessDenied flag (34. sor)
✓ Snapshot validálás (106-110. sor)
✓ Hibaüzenet + visszairányítás (73-97. sor)

Kód részlet:

  _subscription = FirebaseFirestore.instance
      .collection('notes')
      .doc(widget.noteId)
      .snapshots()
      .listen(
        _handleSnapshot,
        onError: (error) {
          if (mounted) {
            setState(() => _accessDenied = true);
            _showAccessDeniedAndGoBack();
          }
        },
      );

════════════════════════════════════════════════════════════════════════════════
III. TESZTELÉSI FORGATÓKÖNYVEK
════════════════════════════════════════════════════════════════════════════════

────────────────────────────────────────────────────────────────────────────────
A) WEBALKALMAZÁS TESZTELÉS
────────────────────────────────────────────────────────────────────────────────

┌────────────────────────────────────────────────────────────────────────────┐
│ TESZT 1: Ingyenes felhasználó - Lista megjelenítés                        │
├────────────────────────────────────────────────────────────────────────────┤
│ Lépések:                                                                   │
│   1. Bejelentkezés ingyenes felhasználóként (nincs aktív előfizetés)      │
│   2. Navigálás /notes oldalra                                              │
│                                                                             │
│ Várt eredmény:                                                             │
│   ✓ MINDEN jegyzet látszik a listában (címek, kategóriák)                 │
│   ✓ Zárt jegyzetek (isFree: false) elhalványítva jelennek meg             │
│   ✓ Zárt jegyzeteknél látható a 🔒 narancs lock ikon                      │
│   ✓ Ingyenes jegyzetek (isFree: true) normálisan jelennek meg             │
└────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────┐
│ TESZT 2: Ingyenes felhasználó - Ingyenes jegyzet megnyitása               │
├────────────────────────────────────────────────────────────────────────────┤
│ Lépések:                                                                   │
│   1. Bejelentkezés ingyenes felhasználóként                                │
│   2. Kattintás egy ingyenes (isFree: true) jegyzetre                      │
│                                                                             │
│ Várt eredmény:                                                             │
│   ✓ A jegyzet részletes nézete megnyílik                                  │
│   ✓ Tartalom látható (HTML, audio, video stb.)                            │
│   ✓ Nincs hibaüzenet                                                      │
└────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────┐
│ TESZT 3: Ingyenes felhasználó - Zárt jegyzet megnyitási kísérlet          │
├────────────────────────────────────────────────────────────────────────────┤
│ Lépések:                                                                   │
│   1. Bejelentkezés ingyenes felhasználóként                                │
│   2. Kattintás egy zárt (isFree: false) jegyzetre                         │
│                                                                             │
│ Várt eredmény:                                                             │
│   ✓ Megjelenik a SnackBar hibaüzenet:                                     │
│     "Ez a tartalom csak előfizetőknek érhető el. ..."                     │
│   ✓ "Előfizetés" gomb látható az üzenetben                                │
│   ✓ A jegyzet NEM nyílik meg                                              │
│   ✓ Gomb kattintására átirányítás /account oldalra                        │
└────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────┐
│ TESZT 4: Ingyenes felhasználó - Közvetlen URL hozzáférés zárt jegyzethez  │
├────────────────────────────────────────────────────────────────────────────┤
│ Lépések:                                                                   │
│   1. Bejelentkezés ingyenes felhasználóként                                │
│   2. URL bevitel: /note/{zárt_jegyzet_id}                                 │
│   3. Enter                                                                 │
│                                                                             │
│ Várt eredmény:                                                             │
│   ✓ NotePagesScreen betöltődik                                            │
│   ✓ Firestore "permission denied" hibát dob                               │
│   ✓ Megjelenik a SnackBar hibaüzenet                                      │
│   ✓ 500ms után automatikus visszairányítás /notes oldalra                 │
└────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────┐
│ TESZT 5: Prémium felhasználó - Minden jegyzet hozzáférés                  │
├────────────────────────────────────────────────────────────────────────────┤
│ Előfeltétel:                                                               │
│   • Firestore: users/{uid} → isSubscriptionActive: true                   │
│                                                                             │
│ Lépések:                                                                   │
│   1. Bejelentkezés prémium felhasználóként                                 │
│   2. Navigálás /notes oldalra                                              │
│   3. Kattintás bármely jegyzetre (ingyenes vagy zárt)                     │
│                                                                             │
│ Várt eredmény:                                                             │
│   ✓ MINDEN jegyzet normálisan jelenik meg (nincs lock ikon, halványítás)  │
│   ✓ Bármely jegyzet megnyitható                                           │
│   ✓ Nincs hibaüzenet                                                      │
└────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────┐
│ TESZT 6: Próbaidőszakos felhasználó - Prémium hozzáférés                  │
├────────────────────────────────────────────────────────────────────────────┤
│ Előfeltétel:                                                               │
│   • Firestore: users/{uid} → freeTrialEndDate: (now + 3 days)             │
│   • isSubscriptionActive: false                                            │
│                                                                             │
│ Lépések:                                                                   │
│   1. Bejelentkezés próbaidőszakos felhasználóként                          │
│   2. Navigálás /notes oldalra                                              │
│   3. Kattintás bármely zárt jegyzetre                                     │
│                                                                             │
│ Várt eredmény:                                                             │
│   ✓ MINDEN jegyzet normálisan jelenik meg                                 │
│   ✓ Zárt jegyzetek is megnyithatók                                        │
│   ✓ Nincs hibaüzenet                                                      │
└────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────┐
│ TESZT 7: Lejárt próbaidőszak - Ingyenes állapot                           │
├────────────────────────────────────────────────────────────────────────────┤
│ Előfeltétel:                                                               │
│   • Firestore: users/{uid} → freeTrialEndDate: (now - 1 day)              │
│   • isSubscriptionActive: false                                            │
│                                                                             │
│ Lépések:                                                                   │
│   1. Bejelentkezés lejárt próbaidőszakos felhasználóként                   │
│   2. Kattintás zárt jegyzetre                                             │
│                                                                             │
│ Várt eredmény:                                                             │
│   ✓ Zárt jegyzetek 🔒 ikonnal jelennek meg                                │
│   ✓ Zárt jegyzet kattintásakor hibaüzenet                                 │
│   ✓ Viselkedés megegyezik az ingyenes felhasználóval                      │
└────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────┐
│ TESZT 8: Admin felhasználó - Teljes hozzáférés                            │
├────────────────────────────────────────────────────────────────────────────┤
│ Előfeltétel:                                                               │
│   • Email: tattila.ninox@gmail.com                                         │
│                                                                             │
│ Lépések:                                                                   │
│   1. Bejelentkezés admin felhasználóként                                   │
│   2. Navigálás /notes oldalra                                              │
│                                                                             │
│ Várt eredmény:                                                             │
│   ✓ MINDEN jegyzet normálisan jelenik meg                                 │
│   ✓ Minden jegyzet megnyitható                                            │
│   ✓ Edit funkciók is elérhetők                                            │
└────────────────────────────────────────────────────────────────────────────┘

────────────────────────────────────────────────────────────────────────────────
B) MOBIL ALKALMAZÁS TESZTELÉS
────────────────────────────────────────────────────────────────────────────────

┌────────────────────────────────────────────────────────────────────────────┐
│ TESZT 9: Mobil - Ingyenes felhasználó - Lista megjelenítés                │
├────────────────────────────────────────────────────────────────────────────┤
│ FONTOS: A mobil app kliensoldali kódja továbbra is csak az                │
│         isFree: true jegyzeteket kérdezi le!                               │
│                                                                             │
│ Lépések:                                                                   │
│   1. Bejelentkezés ingyenes felhasználóként mobilon                        │
│   2. Jegyzetek lista megnyitása                                            │
│                                                                             │
│ Várt eredmény:                                                             │
│   ✓ CSAK az ingyenes jegyzetek látszanak                                  │
│   ✓ Zárt jegyzetek NEM jelennek meg a listában                            │
│   ✓ Nincs lock ikon (nincs zárt jegyzet a listában)                       │
│                                                                             │
│ MAGYARÁZAT:                                                                │
│   A mobil app kliensoldali Firestore query:                                │
│     query.where('isFree', '==', true)                                      │
│                                                                             │
│   Ezért a `allow list` szabály engedélyezi a lista lekérdezést,           │
│   de a mobil kliens már előre szűr az isFree mezőre.                      │
└────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────┐
│ TESZT 10: Mobil - Prémium felhasználó - Minden jegyzet hozzáférés         │
├────────────────────────────────────────────────────────────────────────────┤
│ Előfeltétel:                                                               │
│   • Google Play Store előfizetés aktív                                     │
│   • Firestore: isSubscriptionActive: true                                  │
│                                                                             │
│ Lépések:                                                                   │
│   1. Bejelentkezés prémium felhasználóként mobilon                         │
│   2. Jegyzetek lista megnyitása                                            │
│                                                                             │
│ Várt eredmény:                                                             │
│   ✓ MINDEN jegyzet látszik (ingyenes + zárt)                              │
│   ✓ Minden jegyzet megnyitható                                            │
│   ✓ Nincs hibaüzenet                                                      │
│                                                                             │
│ MEGJEGYZÉS:                                                                │
│   A mobil app is ellenőrizheti a hasPremiumAccess státuszt,               │
│   és ennek alapján lekérdezheti az összes jegyzetet (vagy csak az         │
│   isFree-ket). A Firestore szabály mindkét esetben helyesen működik.      │
└────────────────────────────────────────────────────────────────────────────┘

════════════════════════════════════════════════════════════════════════════════
IV. DEPLOYMENT LÉPÉSEK
════════════════════════════════════════════════════════════════════════════════

┌────────────────────────────────────────────────────────────────────────────┐
│ 1. FIRESTORE SZABÁLY DEPLOY                                               │
├────────────────────────────────────────────────────────────────────────────┤
│   firebase deploy --only firestore:rules                                  │
│                                                                             │
│   Ellenőrzés:                                                              │
│     • Firebase Console → Firestore Database → Rules                       │
│     • Ellenőrizd a "allow list" és "allow get" külön szabályokat          │
└────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────┐
│ 2. WEBALKALMAZÁS BUILD ÉS DEPLOY                                          │
├────────────────────────────────────────────────────────────────────────────┤
│   flutter build web --release                                              │
│   firebase deploy --only hosting                                           │
│                                                                             │
│   Ellenőrzés:                                                              │
│     • Navigálj https://lomedu-user-web.web.app -ra                        │
│     • Teszteld a TESZT 1-8 forgatókönyveket                               │
└────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────┐
│ 3. MOBIL ALKALMAZÁS ELLENŐRZÉS                                            │
├────────────────────────────────────────────────────────────────────────────┤
│   FONTOS: A mobilon NEM KELL újra build-elni!                             │
│                                                                             │
│   A Firestore szabály deploy-ja után a mobil app AUTOMATIKUSAN            │
│   használja az új szabályokat.                                             │
│                                                                             │
│   Ellenőrzés:                                                              │
│     • Nyisd meg a mobil appot                                              │
│     • Teszteld a TESZT 9-10 forgatókönyveket                              │
│     • Ellenőrizd, hogy az ingyenes felhasználók csak az isFree:true       │
│       jegyzeteket látják (kliens-oldali szűrés)                            │
└────────────────────────────────────────────────────────────────────────────┘

════════════════════════════════════════════════════════════════════════════════
V. HIBAKERESÉSI ÚTMUTATÓ
════════════════════════════════════════════════════════════════════════════════

────────────────────────────────────────────────────────────────────────────────
PROBLÉMA 1: Ingyenes felhasználó nem látja a zárt jegyzeteket a webes UI-ban
────────────────────────────────────────────────────────────────────────────────

DIAGNOSZTIKA:
  1. Nyisd meg a Developer Tools → Console
  2. Keresd meg a Firestore query eredményeket
  3. Ellenőrizd: vannak-e "permission-denied" hibák?

MEGOLDÁS:
  ✓ Ha IGEN (permission-denied): A Firestore szabály rosszul van beállítva
    → Ellenőrizd a "allow list" szabályt
    → Deploy újra: firebase deploy --only firestore:rules
  
  ✓ Ha NEM (nincs hiba, de üres lista): A kliens kód hibás
    → Ellenőrizd: note_card_grid.dart, 71. sor körül
    → NEM szabad szűrni isFree alapján!

────────────────────────────────────────────────────────────────────────────────
PROBLÉMA 2: Ingyenes felhasználó meg tudja nyitni a zárt jegyzeteket
────────────────────────────────────────────────────────────────────────────────

DIAGNOSZTIKA:
  1. Ellenőrizd a felhasználói dokumentumot Firestore-ban
  2. Nézd meg: isSubscriptionActive, freeTrialEndDate értékek

MEGOLDÁS:
  ✓ Ha isSubscriptionActive: true → A felhasználó prémium
  ✓ Ha freeTrialEndDate > now → Aktív próbaidőszak
  ✓ Ha mindkettő false/lejárt → Firestore szabály hibás
    → Ellenőrizd a "allow get" szabályt
    → Ellenőrizd a hasPremiumAccess() függvényt

────────────────────────────────────────────────────────────────────────────────
PROBLÉMA 3: Prémium felhasználó nem tudja megnyitni a zárt jegyzeteket
────────────────────────────────────────────────────────────────────────────────

DIAGNOSZTIKA:
  1. Ellenőrizd a felhasználói dokumentumot Firestore-ban
  2. users/{uid} → isSubscriptionActive: true?
  3. Developer Tools → Console → Firestore hibák?

MEGOLDÁS:
  ✓ Ha isSubscriptionActive: false → Frissítsd true-ra (vagy várj a webhook-ra)
  ✓ Ha "permission-denied" hiba → hasPremiumAccess() függvény hibás
    → Ellenőrizd a Firestore szabályban (16. sor körül)

────────────────────────────────────────────────────────────────────────────────
PROBLÉMA 4: Mobil app nem működik (ingyenes felhasználó mindent lát)
────────────────────────────────────────────────────────────────────────────────

DIAGNOSZTIKA:
  1. Ellenőrizd a mobil app kliensoldali kódját
  2. Keresd meg a Firestore query-t a jegyzetek lekérdezéséhez

MEGOLDÁS:
  ✓ A mobil app-ban KELL lennie egy where szűrőnek:
    query.where('isFree', '==', true)  // ingyenes felhasználóknak
  
  ✓ Ha nincs ilyen szűrő → A mobil app kódját kell módosítani
    (NEM a Firestore szabályt!)

════════════════════════════════════════════════════════════════════════════════
VI. TOVÁBBI INFORMÁCIÓK
════════════════════════════════════════════════════════════════════════════════

────────────────────────────────────────────────────────────────────────────────
DOKUMENTÁCIÓ
────────────────────────────────────────────────────────────────────────────────

  • Regisztrációs folyamat: docs/regisztracios_folyamat_web.txt
  • Adatvédelmi irányelvek: docs/adatvedelmi_iranyelvek_web.txt
  • Firestore szabályok: firestore.rules

────────────────────────────────────────────────────────────────────────────────
KAPCSOLÓDÓ FÁJLOK
────────────────────────────────────────────────────────────────────────────────

  Backend:
    • firestore.rules (Firestore szabályok)
  
  Frontend (Web):
    • lib/widgets/note_card_grid.dart (jegyzet lista)
    • lib/widgets/note_list_tile.dart (jegyzet kártya UI)
    • lib/screens/note_pages_screen.dart (részletes nézet)
    • lib/screens/interactive_note_view_screen.dart (interaktív nézet)

────────────────────────────────────────────────────────────────────────────────
VERZIÓKEZELÉS
────────────────────────────────────────────────────────────────────────────────

Git commit üzenet sablon:

  feat: Implement freemium model for notes
  
  - Split Firestore rules: allow list (all users) + allow get (premium only)
  - Remove isFree filter from client-side note queries (web)
  - Add lock icon UI for premium notes
  - Add access denied handling in note detail screens
  - Maintain mobile app compatibility (client-side filtering)
  
  BREAKING CHANGE: None (backward compatible with mobile app)

════════════════════════════════════════════════════════════════════════════════
DOKUMENTUM VÉGE
════════════════════════════════════════════════════════════════════════════════

