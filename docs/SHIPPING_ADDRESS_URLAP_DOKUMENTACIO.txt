================================================================================
                  SZÃLLÃTÃSI CÃM Å°RLAP - RÃ‰SZLETES DOKUMENTÃCIÃ“
                         Lomedu Web - Shipping Address System
================================================================================

TARTALOMJEGYZÃ‰K
----------------
1. ÃTTEKINTÃ‰S
2. KOMPONENS STRUKTÃšRA
3. Å°RLAP MEZÅK Ã‰S VALIDÃCIÃ“
4. MÅ°KÃ–DÃ‰SI FOLYAMAT
5. ADATKEZELÃ‰S Ã‰S BIZTONSÃG
6. UI/UX JELLEMZÅK
7. INTEGRÃCIÃ“ A FIZETÃ‰SI FOLYAMATTAL
8. TERVEZETT FOLYAMAT RÃ‰SZLETES LEÃRÃSA
9. JELENLEGI ÃLLAPOT Ã‰S IMPLEMENTÃCIÃ“

================================================================================
1. ÃTTEKINTÃ‰S
================================================================================

A szÃ¡llÃ­tÃ¡si cÃ­m Å±rlap az Account kÃ©pernyÅ‘n megjelenÅ‘ form komponens, amely
a szÃ¡mlÃ¡zÃ¡shoz szÃ¼ksÃ©ges szÃ¡llÃ­tÃ¡si adatok kezelÃ©sÃ©t vÃ©gzi.

**ShippingAddressForm** (lib/widgets/shipping_address_form.dart)
- Account kÃ©pernyÅ‘n megjelenÅ‘ form (nem felugrÃ³ dialÃ³gus!)
- FeltÃ©teles szerkeszthetÅ‘sÃ©g: csak akkor szerkeszthetÅ‘, ha:
  * Az elÅ‘fizetÃ©s lejÃ¡rt VAGY
  * Az elÅ‘fizetÃ©s 3 nap mÃºlva lejÃ¡r VAGY
  * Admin felhasznÃ¡lÃ³ (mindig szerkeszthetÅ‘)
- Ideiglenes tÃ¡rolÃ¡s a users kollekciÃ³ban (szÃ¡mla utÃ¡n tÃ¶rlÅ‘dik)
- Admin funkciÃ³k teszt szÃ¡mla generÃ¡lÃ¡shoz

FONTOS: A komponens jelenleg mÅ±kÃ¶dik, de a fizetÃ©si folyamatban mÃ©g nincs 
teljesen integrÃ¡lva. A tervezett folyamat szerint a fizetÃ©s indÃ­tÃ¡sakor 
ellenÅ‘rzi, hogy van-e kitÃ¶ltve a szÃ¡llÃ­tÃ¡si cÃ­m, Ã©s ha nincs, akkor kÃ©ri 
a kitÃ¶ltÃ©st.

================================================================================
2. KOMPONENS STRUKTÃšRA
================================================================================

2.1 SHIPPINGADDRESSFORM
------------------------
FÃ¡jl: lib/widgets/shipping_address_form.dart
MÃ©ret: 900+ sor
ElhelyezkedÃ©s: Account kÃ©pernyÅ‘ (lib/screens/account_screen.dart)

Komponens struktÃºra:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ShippingAddressForm (StatefulWidget)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Props:                                                     â”‚
â”‚ - userData: Map<String, dynamic>                           â”‚
â”‚ - canEdit: bool (elÅ‘fizetÃ©s Ã¡llapota alapjÃ¡n)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _ShippingAddressFormState                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ State vÃ¡ltozÃ³k:                                             â”‚
â”‚ - _formKey: GlobalKey<FormState>                            â”‚
â”‚ - _nameController: TextEditingController                    â”‚
â”‚ - _zipCodeController: TextEditingController                 â”‚
â”‚ - _cityController: TextEditingController                    â”‚
â”‚ - _addressController: TextEditingController                 â”‚
â”‚ - _isEditing: bool                                          â”‚
â”‚ - _isSaving: bool                                           â”‚
â”‚ - _isAdmin: bool                                            â”‚
â”‚ - _isGeneratingInvoice: bool                                â”‚
â”‚ - _postalCodes: Map<String, List<String>>                  â”‚
â”‚ - _availableCities: List<String>?                          â”‚
â”‚ - _selectedTestStatus: String (admin teszt)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FÅ‘bb funkciÃ³k:
- SzÃ¡llÃ­tÃ¡si cÃ­m megjelenÃ­tÃ©se Ã©s szerkesztÃ©se
- FeltÃ©teles szerkeszthetÅ‘sÃ©g (elÅ‘fizetÃ©s Ã¡llapota alapjÃ¡n)
- Admin teszt szÃ¡mla generÃ¡lÃ¡s
- Ideiglenes mentÃ©s Firestore-ba (users kollekciÃ³, szÃ¡mla utÃ¡n tÃ¶rlÅ‘dik)
- IrÃ¡nyÃ­tÃ³szÃ¡m-telepÃ¼lÃ©s automatikus keresÃ©s

================================================================================
3. Å°RLAP MEZÅK Ã‰S VALIDÃCIÃ“
================================================================================

3.1 ADATMEZÅK
-------------
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MezÅ‘             â”‚ KÃ¶telezÅ‘    â”‚ LeÃ­rÃ¡s                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NÃ©v/CÃ©gnÃ©v       â”‚ IGEN        â”‚ MagÃ¡nszemÃ©ly neve vagy cÃ©gnÃ©v      â”‚
â”‚ IrÃ¡nyÃ­tÃ³szÃ¡m     â”‚ IGEN        â”‚ 4 szÃ¡mjegy, automatikus telepÃ¼lÃ©s  â”‚
â”‚ TelepÃ¼lÃ©s        â”‚ IGEN        â”‚ Auto-fill vagy vÃ¡lasztÃ¡s listÃ¡bÃ³l  â”‚
â”‚ Utca, hÃ¡zszÃ¡m    â”‚ IGEN        â”‚ Pontos cÃ­m                          â”‚
â”‚ AdÃ³szÃ¡m          â”‚ FELTÃ‰TELES  â”‚ CÃ©g: kÃ¶telezÅ‘, MagÃ¡n: opcionÃ¡lis   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3.2 VALIDÃCIÃ“S SZABÃLYOK
-------------------------
```dart
// NÃ©v validÃ¡ciÃ³
validator: (value) {
  if (value == null || value.trim().isEmpty) {
    return 'A ${_isCompany ? "cÃ©gnÃ©v" : "nÃ©v"} megadÃ¡sa kÃ¶telezÅ‘';
  }
  return null;
}

// IrÃ¡nyÃ­tÃ³szÃ¡m validÃ¡ciÃ³
validator: (value) {
  if (value == null || value.trim().isEmpty) {
    return 'KÃ¶telezÅ‘';
  }
  if (!RegExp(r'^\d{4}$').hasMatch(value.trim())) {
    return '4 szÃ¡mjegy';
  }
  return null;
}

// AdÃ³szÃ¡m validÃ¡ciÃ³ (cÃ©g esetÃ©n)
validator: _isCompany
  ? (value) {
      if (value == null || value.trim().isEmpty) {
        return 'Jogi szemÃ©ly esetÃ©n az adÃ³szÃ¡m megadÃ¡sa kÃ¶telezÅ‘';
      }
      return null;
    }
  : null
```

3.3 MAGÃNSZEMÃ‰LY VS CÃ‰G LOGIKA
-------------------------------
MEGJEGYZÃ‰S: A jelenlegi ShippingAddressForm-ban NINCS cÃ©g/magÃ¡nszemÃ©ly 
vÃ¡lasztÃ³ Ã©s adÃ³szÃ¡m mezÅ‘. Ezeket hozzÃ¡ kell adni a tervezett folyamat 
szerint.

Tervezett logika:
- Checkbox: "Jogi szemÃ©lykÃ©nt vÃ¡sÃ¡rolok"
- Ha bejelÃ¶lve â†’ CÃ©gnÃ©v Ã©s adÃ³szÃ¡m kÃ¶telezÅ‘
- Ha nincs bejelÃ¶lve â†’ NÃ©v kÃ¶telezÅ‘, adÃ³szÃ¡m opcionÃ¡lis
- AdÃ³szÃ¡m mezÅ‘ csak akkor jelenik meg, ha cÃ©g vagy opcionÃ¡lis magÃ¡nszemÃ©ly

================================================================================
4. MÅ°KÃ–DÃ‰SI FOLYAMAT
================================================================================

4.1 SZERKESZTHETÅSÃ‰GI FELTÃ‰TELEK
---------------------------------
A form szerkeszthetÅ‘sÃ©gÃ©t az elÅ‘fizetÃ©s Ã¡llapota hatÃ¡rozza meg:

```dart
bool _canEditShippingAddress(Map<String, dynamic> data) {
  final isActive = data['isSubscriptionActive'] == true;
  final endDate = data['subscriptionEndDate'];
  
  if (!isActive) {
    return true; // LejÃ¡rt elÅ‘fizetÃ©s â†’ szerkeszthetÅ‘
  }
  
  if (endDate != null) {
    final daysUntilExpiry = endDate.difference(DateTime.now()).inDays;
    return daysUntilExpiry <= 3; // 3 napon belÃ¼l lejÃ¡r â†’ szerkeszthetÅ‘
  }
  
  return false; // AktÃ­v elÅ‘fizetÃ©s â†’ NEM szerkeszthetÅ‘
}
```

SzerkeszthetÅ‘, ha:
âœ… ElÅ‘fizetÃ©s lejÃ¡rt (isSubscriptionActive: false)
âœ… ElÅ‘fizetÃ©s 3 nap mÃºlva lejÃ¡r (daysUntilExpiry â‰¤ 3)
âœ… Admin felhasznÃ¡lÃ³ (mindig szerkeszthetÅ‘)

4.2 AUTOMATIKUS ADATBETÃ–LTÃ‰S
-----------------------------
1. FelhasznÃ¡lÃ³ nÃ©v betÃ¶ltÃ©se Firestore-bÃ³l:
   - users kollekciÃ³bÃ³l: firstName + lastName
   - VAGY displayName
   - VAGY email prefix

2. Mentett szÃ¡llÃ­tÃ¡si cÃ­m betÃ¶ltÃ©se:
   - users.shippingAddress mezÅ‘bÅ‘l
   - Ha nincs, akkor nÃ©v alapjÃ¡n kitÃ¶ltÃ©s

3. IrÃ¡nyÃ­tÃ³szÃ¡m â†’ TelepÃ¼lÃ©s automatikus kitÃ¶ltÃ©s:
   - assets/postal_codes.json fÃ¡jlbÃ³l
   - 4 szÃ¡mjegy beÃ­rÃ¡sa utÃ¡n
   - Ha tÃ¶bb telepÃ¼lÃ©s: bottom sheet vÃ¡lasztÃ³lista

4.3 ADATMENTÃ‰S
--------------
```dart
// Firestore-ba mentÃ©s (users kollekciÃ³)
await FirebaseFirestore.instance
    .collection('users')
    .doc(user.uid)
    .update({
  'shippingAddress': {
    'name': _nameController.text.trim(),
    'zipCode': _zipCodeController.text.trim(),
    'city': _cityController.text.trim(),
    'address': _addressController.text.trim(),
  },
  'updatedAt': FieldValue.serverTimestamp(),
});
```

4.4 FIZETÃ‰SI FOLYAMAT INTEGRÃCIÃ“JA
-----------------------------------
TERVEZETT FOLYAMAT:

1. FelhasznÃ¡lÃ³ el akarja indÃ­tani az elÅ‘fizetÃ©st
   â†“
2. EllenÅ‘rzÃ©s: Van-e kitÃ¶ltve shippingAddress?
   â†“
3a. HA NINCS â†’ KÃ©ri a kitÃ¶ltÃ©st (Account kÃ©pernyÅ‘re irÃ¡nyÃ­tÃ¡s)
   â†“
3b. HA VAN â†’ FizetÃ©s indÃ­tÃ¡sa
   â†“
4. Sikeres fizetÃ©s visszatÃ©rÃ©s
   â†“
5. Automatikus szÃ¡mla generÃ¡lÃ¡s (shippingAddress alapjÃ¡n)
   â†“
6. SzÃ¡mla generÃ¡lÃ¡s utÃ¡n shippingAddress tÃ¶rlÃ©se a web_payments rekordbÃ³l

================================================================================
5. ADATKEZELÃ‰S Ã‰S BIZTONSÃG
================================================================================

5.1 IDEIGLENES TÃROLÃS
-----------------------
A szÃ¡llÃ­tÃ¡si cÃ­m IDEIGLENESEN tÃ¡rolÃ³dik, szÃ¡mla generÃ¡lÃ¡s utÃ¡n TÃ–RLÅDIK:

1. **Users kollekciÃ³** (ideiglenes tÃ¡rolÃ¡s):
   - users/{userId}/shippingAddress
   - SzerkeszthetÅ‘ az Account kÃ©pernyÅ‘n
   - A "MentÃ©s" gombbal mentve
   - SzÃ¡mla generÃ¡lÃ¡s utÃ¡n AUTOMATIKUS TÃ–RLÃ‰S
   - CÃ©l: csak a szÃ¡mla generÃ¡lÃ¡shoz szÃ¼ksÃ©ges

2. **Web_payments kollekciÃ³** (ideiglenes tÃ¡rolÃ¡s):
   - web_payments/{orderRef}/shippingAddress
   - FizetÃ©s indÃ­tÃ¡sakor mÃ¡solÃ³dik ide a users kollekciÃ³bÃ³l
   - SzÃ¡mla generÃ¡lÃ¡s utÃ¡n AUTOMATIKUS TÃ–RLÃ‰S
   - CÃ©l: csak a szÃ¡mla generÃ¡lÃ¡shoz szÃ¼ksÃ©ges, utÃ¡na nem kell

FONTOS: MindkÃ©t helyen tÃ¶rlÅ‘dik a szÃ¡mla generÃ¡lÃ¡s utÃ¡n! Nincs tartÃ³s mentÃ©s.

5.2 BIZTONSÃGI INTÃ‰ZKEDÃ‰SEK
----------------------------
- SzerkeszthetÅ‘sÃ©g csak bizonyos feltÃ©telek mellett
- Adatok csak a szÃ¡mlÃ¡zÃ¡shoz szÃ¼ksÃ©gesek
- GDPR megfelelÅ‘sÃ©g: minimÃ¡lis adattÃ¡rolÃ¡s
- web_payments shippingAddress automatikus tÃ¶rlÃ©se

5.3 FIRESTORE STRUKTÃšRA
------------------------
```javascript
// 1. IDEIGLENES TÃROLÃS - users kollekciÃ³
// SzÃ¡mla generÃ¡lÃ¡s utÃ¡n TÃ–RLÅDIK!
{
  userId: "...",
  shippingAddress: {
    name: "KovÃ¡cs JÃ¡nos",
    zipCode: "2030",
    city: "Ã‰rd",
    address: "TÃ¡rnoki Ãºt 23."
  },
  updatedAt: timestamp
  // shippingAddress tÃ¶rlÅ‘dik szÃ¡mla generÃ¡lÃ¡s utÃ¡n
}

// 2. IDEIGLENES TÃROLÃS - web_payments kollekciÃ³
// SzÃ¡mla generÃ¡lÃ¡s utÃ¡n TÃ–RLÅDIK!
{
  userId: "...",
  planId: "...",
  amount: 4350,
  shippingAddress: {
    name: "KovÃ¡cs JÃ¡nos",
    zipCode: "2030",
    city: "Ã‰rd",
    address: "TÃ¡rnoki Ãºt 23.",
    isCompany: "false",
    taxNumber: ""  // opcionÃ¡lis
  },
  status: "COMPLETED",
  createdAt: timestamp
  // shippingAddress tÃ¶rlÅ‘dik szÃ¡mla generÃ¡lÃ¡s utÃ¡n
}
```

5.4 ADATTÃ–RLÃ‰S FOLYAMATA
-------------------------
```javascript
// functions/index.js - generateAndSendInvoice utÃ¡n
if (!testPaymentData) {
  // 1. SzÃ¡llÃ­tÃ¡si cÃ­m tÃ¶rlÃ©se a payment record-bÃ³l
  await paymentRef.update({
    shippingAddress: admin.firestore.FieldValue.delete()
  });
  
  // 2. SzÃ¡llÃ­tÃ¡si cÃ­m tÃ¶rlÃ©se a users kollekciÃ³bÃ³l is
  await db.collection('users').doc(userId).update({
    shippingAddress: admin.firestore.FieldValue.delete()
  });
}
```

PÃ‰LDA:
------
1. FelhasznÃ¡lÃ³ kitÃ¶lti a formot â†’ users/{userId}/shippingAddress = "KovÃ¡cs JÃ¡nos, 2030 Ã‰rd..."
2. FizetÃ©s indÃ­tÃ¡sa â†’ web_payments/{orderRef}/shippingAddress = "KovÃ¡cs JÃ¡nos, 2030 Ã‰rd..." (mÃ¡solat)
3. SzÃ¡mla generÃ¡lÃ¡s â†’ sikeres
4. AdattÃ¶rlÃ©s:
   - web_payments/{orderRef}/shippingAddress = TÃ–RÃ–LVE âœ…
   - users/{userId}/shippingAddress = TÃ–RÃ–LVE âœ…

KÃ¶vetkezÅ‘ vÃ¡sÃ¡rlÃ¡snÃ¡l:
- Ãšjra ki kell tÃ¶lteni a formot
- Nincs elÅ‘re kitÃ¶ltÃ©s

================================================================================
6. UI/UX JELLEMZÅK
================================================================================

6.1 VIZUÃLIS DESIGN
-------------------
- Card komponens az Account kÃ©pernyÅ‘n
- Modern, kerekÃ­tett sarkok (BorderRadius: 12px)
- KÃ©k szÃ­nsÃ©ma (#1E3A8A)
- Ikonok minden mezÅ‘nÃ©l
- ReszponzÃ­v elrendezÃ©s (kis kÃ©pernyÅ‘n: egymÃ¡s alatt, nagy kÃ©pernyÅ‘n: egymÃ¡s mellett)
- ElÅ‘fizetÃ©si Ã¡llapot kÃ¡rtya mellett jelenik meg

6.2 FELHASZNÃLÃ“I Ã‰LMÃ‰NY
------------------------
- Loading indikÃ¡tor irÃ¡nyÃ­tÃ³szÃ¡m keresÃ©snÃ©l
- Automatikus mezÅ‘kitÃ¶ltÃ©s
- Tiszta hibaÃ¼zenetek
- VizuÃ¡lis visszajelzÃ©s (szÃ­nek, keretek)

6.3 TELEPÃœLÃ‰S VÃLASZTÃ“
-----------------------
Ha tÃ¶bb telepÃ¼lÃ©s tartozik az irÃ¡nyÃ­tÃ³szÃ¡mhoz:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â„¹ï¸ 3 telepÃ¼lÃ©s talÃ¡lhatÃ³, vÃ¡lassz egyet: â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ¢ Budapest III. kerÃ¼let                â”‚
â”‚ ğŸ¢ Budapest XIII. kerÃ¼let               â”‚
â”‚ ğŸ¢ Budapest XIV. kerÃ¼let                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

6.4 SZERKESZTÃ‰S GOMB
---------------------
- Csak akkor jelenik meg, ha canEdit: true
- KÃ©k "SzerkesztÃ©s" gomb ceruza ikonnal
- KattintÃ¡sra az Ã¶sszes mezÅ‘ szerkeszthetÅ‘vÃ© vÃ¡lik
- Menti/MÃ©gse gombok megjelennek

================================================================================
7. INTEGRÃCIÃ“ A FIZETÃ‰SI FOLYAMATTAL
================================================================================

7.1 TERVEZETT FOLYAMAT
-----------------------
```dart
// subscription_renewal_button.dart vagy web_payment_plans.dart

// 1. AdattovÃ¡bbÃ­tÃ¡si nyilatkozat
final consentAccepted = await DataTransferConsentDialog.show(context);
if (!consentAccepted) return;

// 2. EllenÅ‘rzÃ©s: Van-e shippingAddress a users kollekciÃ³ban?
final userDoc = await FirebaseFirestore.instance
    .collection('users')
    .doc(userId)
    .get();
    
final shippingAddress = userDoc.data()?['shippingAddress'];

if (shippingAddress == null || shippingAddress.isEmpty) {
  // 3a. HA NINCS â†’ KÃ©ri a kitÃ¶ltÃ©st
  // Account kÃ©pernyÅ‘re irÃ¡nyÃ­tÃ¡s Ã¼zenettel
  if (mounted) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text('KÃ©rjÃ¼k, tÃ¶ltse ki a szÃ¡llÃ­tÃ¡si adatokat az Account kÃ©pernyÅ‘n!'),
        action: SnackBarAction(
          label: 'UgrÃ¡s',
          onPressed: () => context.go('/account'),
        ),
      ),
    );
  }
  return;
}

// 3b. HA VAN â†’ FizetÃ©s indÃ­tÃ¡sa cÃ­mmel
final result = await HybridPaymentService.initiatePayment(
  planId: planId,
  userId: user.uid,
  shippingAddress: Map<String, String>.from(shippingAddress),
);
```

7.2 BACKEND FOLYAMAT
---------------------
```javascript
// functions/index.js - initiateWebPayment
// Shipping address mÃ¡solÃ¡sa users-bÅ‘l web_payments-be
if (data.shippingAddress) {
  paymentData.shippingAddress = data.shippingAddress;
} else {
  // Ha nincs a kÃ©rÃ©sben, prÃ³bÃ¡ljuk a users kollekciÃ³bÃ³l
  const userDoc = await db.collection('users').doc(userId).get();
  const userShippingAddress = userDoc.data()?.shippingAddress;
  if (userShippingAddress) {
    paymentData.shippingAddress = userShippingAddress;
  }
}

// functions/index.js - onWebPaymentWrite trigger
// Sikeres fizetÃ©s utÃ¡n szÃ¡mla generÃ¡lÃ¡s
if (after.status === 'COMPLETED' && after.shippingAddress) {
  await generateAndSendInvoice(userId, orderRef, paymentInfo);
  
  // SzÃ¡mla generÃ¡lÃ¡s utÃ¡n shippingAddress tÃ¶rlÃ©se MINDKÃ‰T HELYEN
  // 1. web_payments rekordbÃ³l
  await paymentRef.update({
    shippingAddress: admin.firestore.FieldValue.delete()
  });
  
  // 2. users kollekciÃ³bÃ³l is
  await db.collection('users').doc(userId).update({
    shippingAddress: admin.firestore.FieldValue.delete()
  });
}
```

7.3 FOLYAMATÃBRA
----------------
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FelhasznÃ¡lÃ³: ElÅ‘fizetÃ©s indÃ­tÃ¡sa                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. AdattovÃ¡bbÃ­tÃ¡si nyilatkozat elfogadÃ¡sa               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. EllenÅ‘rzÃ©s: Van-e shippingAddress?                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                               â”‚
       â”‚ NINCS                          â”‚ VAN
       â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Account kÃ©pernyÅ‘re   â”‚    â”‚ 3. FizetÃ©s indÃ­tÃ¡sa           â”‚
â”‚ irÃ¡nyÃ­tÃ¡s Ã¼zenettel  â”‚    â”‚    shippingAddress-szal       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ 4. SimplePay fizetÃ©s          â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ 5. Sikeres fizetÃ©s visszatÃ©rÃ©s â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ 6. SzÃ¡mla generÃ¡lÃ¡s           â”‚
                          â”‚    (shippingAddress alapjÃ¡n)  â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ 7. shippingAddress tÃ¶rlÃ©se   â”‚
                          â”‚    web_payments rekordbÃ³l     â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

================================================================================
8. TERVEZETT FOLYAMAT RÃ‰SZLETES LEÃRÃSA
================================================================================

8.0 TELJES FOLYAMAT LÃ‰PÃ‰SRÅL LÃ‰PÃ‰SRE
-------------------------------------

1. FELHASZNÃLÃ“ EL AKARJA INDÃTANI AZ ELÅFIZETÃ‰ST
   - RÃ¡kattint az "ElÅ‘fizetÃ©s" vagy "MegÃºjÃ­tÃ¡s" gombra
   - subscription_renewal_button.dart vagy web_payment_plans.dart

2. ADATTOVÃBBÃTÃSI NYILATKOZAT
   - DataTransferConsentDialog megjelenÃ­tÃ©se
   - ElfogadÃ¡s kÃ¶telezÅ‘ a folytatÃ¡shoz
   - Firestore frissÃ­tÃ©s: dataTransferConsentLastAcceptedDate

3. SZÃLLÃTÃSI CÃM ELLENÅRZÃ‰S
   ```dart
   final userDoc = await FirebaseFirestore.instance
       .collection('users')
       .doc(userId)
       .get();
   final shippingAddress = userDoc.data()?['shippingAddress'];
   ```

4a. HA NINCS SZÃLLÃTÃSI CÃM
   - SnackBar Ã¼zenet megjelenÃ­tÃ©se
   - "KÃ©rjÃ¼k, tÃ¶ltse ki a szÃ¡llÃ­tÃ¡si adatokat az Account kÃ©pernyÅ‘n!"
   - "UgrÃ¡s" gomb â†’ context.go('/account')
   - FOLYAMAT MEGSZAKAD

4b. HA VAN SZÃLLÃTÃSI CÃM
   - FizetÃ©s indÃ­tÃ¡sa shippingAddress-szal
   - HybridPaymentService.initiatePayment()
   - shippingAddress Ã¡tadÃ¡sa a Cloud Function-nek

5. BACKEND: FIZETÃ‰SI REKORD LÃ‰TREHOZÃSA
   ```javascript
   // functions/index.js - initiateWebPayment
   paymentData.shippingAddress = data.shippingAddress;
   // vagy users kollekciÃ³bÃ³l mÃ¡solÃ¡s
   ```

6. SIMPLEPAY FIZETÃ‰S
   - ÃtirÃ¡nyÃ­tÃ¡s SimplePay fizetÃ©si oldalra
   - FelhasznÃ¡lÃ³ fizetÃ©s vÃ©grehajtÃ¡sa

7. SIKERES FIZETÃ‰S VISSZATÃ‰RÃ‰S
   - SimplePay callback/webhook
   - web_payments stÃ¡tusz frissÃ­tÃ©se: 'COMPLETED'

8. AUTOMATIKUS SZÃMLA GENERÃLÃS
   ```javascript
   // functions/index.js - onWebPaymentWrite trigger
   if (after.status === 'COMPLETED' && after.shippingAddress) {
     await generateAndSendInvoice(userId, orderRef, paymentInfo);
   }
   ```

9. SZÃMLA GENERÃLÃS UTÃN ADATTÃ–RLÃ‰S
   ```javascript
   // 1. shippingAddress tÃ¶rlÃ©se web_payments rekordbÃ³l
   await paymentRef.update({
     shippingAddress: admin.firestore.FieldValue.delete()
   });
   
   // 2. shippingAddress tÃ¶rlÃ©se users kollekciÃ³bÃ³l is
   await db.collection('users').doc(userId).update({
     shippingAddress: admin.firestore.FieldValue.delete()
   });
   ```
   
   MEGJEGYZÃ‰S: MindkÃ©t helyen tÃ¶rlÅ‘dik! Nincs tartÃ³s mentÃ©s.

================================================================================
9. JELENLEGI ÃLLAPOT Ã‰S IMPLEMENTÃCIÃ“
================================================================================

9.1 JELENLEGI ÃLLAPOT
---------------------
âœ… ShippingAddressForm komponens elkÃ©szÃ¼lt Ã©s mÅ±kÃ¶dÅ‘kÃ©pes
âœ… ValidÃ¡ciÃ³k implementÃ¡lva
âœ… IrÃ¡nyÃ­tÃ³szÃ¡m-telepÃ¼lÃ©s automatizmus mÅ±kÃ¶dik
âœ… FeltÃ©teles szerkeszthetÅ‘sÃ©g implementÃ¡lva
âœ… Admin teszt szÃ¡mla funkciÃ³ mÅ±kÃ¶dik
âœ… Backend tÃ¡mogatÃ¡s kÃ©sz (initiateWebPayment, generateAndSendInvoice)
âœ… AdattÃ¶rlÃ©s logika implementÃ¡lva
âš ï¸ FizetÃ©si folyamatban mÃ©g nincs teljes integrÃ¡ciÃ³

9.2 IMPLEMENTÃLÃSHOZ SZÃœKSÃ‰GES LÃ‰PÃ‰SEK
---------------------------------------
1. subscription_renewal_button.dart mÃ³dosÃ­tÃ¡sa:
   ```dart
   // Shipping address ellenÅ‘rzÃ©s hozzÃ¡adÃ¡sa
   final userDoc = await FirebaseFirestore.instance
       .collection('users')
       .doc(user.uid)
       .get();
   final shippingAddress = userDoc.data()?['shippingAddress'];
   
   if (shippingAddress == null || shippingAddress.isEmpty) {
     // Account kÃ©pernyÅ‘re irÃ¡nyÃ­tÃ¡s
     ScaffoldMessenger.of(context).showSnackBar(...);
     context.go('/account');
     return;
   }
   ```

2. web_payment_plans.dart mÃ³dosÃ­tÃ¡sa:
   - Ugyanaz mint fent

3. Backend ellenÅ‘rzÃ©s:
   - initiateWebPayment automatikus shippingAddress mÃ¡solÃ¡s
   - generateAndSendInvoice shippingAddress ellenÅ‘rzÃ©s
   - AdattÃ¶rlÃ©s mÅ±kÃ¶dÃ©sÃ©nek ellenÅ‘rzÃ©se

4. TesztelÃ©s:
   - Shipping address kitÃ¶ltÃ©s â†’ FizetÃ©s indÃ­tÃ¡s
   - Shipping address hiÃ¡ny â†’ Account irÃ¡nyÃ­tÃ¡s
   - SzÃ¡mla generÃ¡lÃ¡s shippingAddress-szal
   - Shipping address tÃ¶rlÃ©s szÃ¡mla utÃ¡n

9.3 ADMIN FUNKCIÃ“K
-------------------
A ShippingAddressForm tartalmaz admin-specifikus funkciÃ³kat:

1. **Teszt szÃ¡mlÃ¡zÃ¡s**:
   - FizetÃ©si stÃ¡tusz vÃ¡lasztÃ³ (COMPLETED, FAILED, stb.)
   - Teszt szÃ¡mla generÃ¡lÃ¡s gomb
   - Teszt adatokkal szÃ¡mla lÃ©trehozÃ¡sa

2. **Mindig szerkeszthetÅ‘**:
   - Admin felhasznÃ¡lÃ³k szÃ¡mÃ¡ra nincs korlÃ¡tozÃ¡s
   - AktÃ­v elÅ‘fizetÃ©s esetÃ©n is szerkeszthetÅ‘

9.4 FEJLESZTÃ‰SI JAVASLATOK
---------------------------
1. âš ï¸ KÃ–TELEZÅ: CÃ©g/magÃ¡nszemÃ©ly vÃ¡lasztÃ³ hozzÃ¡adÃ¡sa:
   - Checkbox: "Jogi szemÃ©lykÃ©nt vÃ¡sÃ¡rolok"
   - CÃ©gnÃ©v mezÅ‘ (nÃ©v helyett, ha cÃ©g)
   - AdÃ³szÃ¡m mezÅ‘ feltÃ©teles megjelenÃ­tÃ©s
   - ValidÃ¡ciÃ³: cÃ©g esetÃ©n adÃ³szÃ¡m kÃ¶telezÅ‘

2. CÃ­m validÃ¡ciÃ³ bÅ‘vÃ­tÃ©se:
   - AdÃ³szÃ¡m formÃ¡tum ellenÅ‘rzÃ©s (8 szÃ¡mjegy-1-2 szÃ¡mjegy)
   - NemzetkÃ¶zi cÃ­mek tÃ¡mogatÃ¡sa

3. ElÅ‘re kitÃ¶ltÃ©s javÃ­tÃ¡s:
   - KorÃ¡bbi vÃ¡sÃ¡rlÃ¡s cÃ­mÃ©nek automatikus betÃ¶ltÃ©se
   - Google Autocomplete integrÃ¡ciÃ³

4. TÃ¶bbnyelvÅ±sÃ©g:
   - Angol nyelv tÃ¡mogatÃ¡sa
   - Dinamikus nyelvÃ¡ltÃ¡s

================================================================================
Ã–SSZEFOGLALÃS
================================================================================

A szÃ¡llÃ­tÃ¡si cÃ­m Å±rlap (ShippingAddressForm) egy teljes funkcionalitÃ¡sÃº, 
jÃ³l megtervezett komponens, amely az Account kÃ©pernyÅ‘n jelenik meg.

TERVEZETT FOLYAMAT:
1. FelhasznÃ¡lÃ³ el akarja indÃ­tani az elÅ‘fizetÃ©st
2. EllenÅ‘rzÃ©s: Van-e kitÃ¶ltve shippingAddress?
3. Ha nincs â†’ KÃ©ri a kitÃ¶ltÃ©st (Account kÃ©pernyÅ‘re irÃ¡nyÃ­tÃ¡s)
4. Ha van â†’ FizetÃ©s indÃ­tÃ¡sa shippingAddress-szal
5. Sikeres fizetÃ©s utÃ¡n automatikus szÃ¡mla generÃ¡lÃ¡s
6. SzÃ¡mla generÃ¡lÃ¡s utÃ¡n shippingAddress tÃ¶rlÃ©se web_payments-bÅ‘l

FÅ‘bb jellemzÅ‘k:
âœ… Account kÃ©pernyÅ‘n megjelenÅ‘ form (nem dialÃ³gus)
âœ… FeltÃ©teles szerkeszthetÅ‘sÃ©g (lejÃ¡rt/3 nap mÃºlva lejÃ¡r elÅ‘fizetÃ©s)
âœ… Admin funkciÃ³k (teszt szÃ¡mla, mindig szerkeszthetÅ‘)
âœ… Automatikus irÃ¡nyÃ­tÃ³szÃ¡m-telepÃ¼lÃ©s keresÃ©s
âœ… Ideiglenes tÃ¡rolÃ¡s users kollekciÃ³ban (szÃ¡mla utÃ¡n tÃ¶rlÅ‘dik)
âœ… Ideiglenes mÃ¡solat web_payments-ben (szÃ¡mla utÃ¡n tÃ¶rlÅ‘dik)
âœ… Backend teljes tÃ¡mogatÃ¡s
âœ… AdattÃ¶rlÃ©s mindkÃ©t helyen szÃ¡mla generÃ¡lÃ¡s utÃ¡n

A komponens kÃ©szen Ã¡ll a hasznÃ¡latra, csak a fizetÃ©si folyamatban kell 
implementÃ¡lni az ellenÅ‘rzÃ©st Ã©s az irÃ¡nyÃ­tÃ¡st.

================================================================================
                              DOKUMENTUM VÃ‰GE
================================================================================

